<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ stream_name }} - Stream Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card-header { font-weight: 500; }
        .metadata-container { max-height: 400px; overflow-y: auto; }
        .process-card { margin-bottom: 1rem; border-left: 4px solid #0d6efd; }
        .process-card .card-header { background-color: rgba(13, 110, 253, 0.05); }
        .stream-url { font-family: monospace; font-size: 0.9rem; }
        .url-badge { cursor: pointer; }
        .url-badge:hover { opacity: 0.8; }
        
        /* Toast styles */
        .toast {
            transition: opacity 0.15s ease;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .toast:not(.show) {
            opacity: 0;
            display: block;
        }
        
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
        }
        
        .toast-body {
            padding: 0.75rem;
        }
        
        /* Push configuration styles from dashboard */
        .push-config {
            border-radius: 0.5rem;
            font-size: 0.85rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .push-active {
            background-color: rgba(34, 197, 94, 0.1);
            border-left: 3px solid #22c55e;
        }
        
        .push-inactive {
            background-color: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
        }
        
        .push-target {
            word-break: break-all;
            font-family: "Roboto Mono", monospace;
            font-size: 0.75rem;
        }
        
        .push-notes {
            color: inherit;
            opacity: 0.8;
            word-break: break-word;
            font-size: 0.8rem;
        }
        
        .push-controls .spinner-border {
            vertical-align: text-top;
            margin-right: 5px;
        }
        
        .push-controls .btn:disabled {
            opacity: 0.7;
        }
        
        .push-controls .input-group {
            margin-bottom: 8px;
        }
        
        .push-controls .input-group input {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem 0 0 0.375rem;
        }
        
        .push-controls .input-group .btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0 0.375rem 0.375rem 0;
        }
        
        .push-status-container {
            max-height: 150px;
            overflow-y: auto;
            padding-right: 5px;
            scrollbar-width: thin;
        }
    </style>
</head>
<body>
    <!-- Add toast container -->
    <div id="toastContainer"></div>
    
    <div class="container-fluid py-4">
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <a href="/dashboard" class="text-decoration-none me-3"><i class="bi bi-arrow-left"></i></a>
        Stream: {{ stream_name }}
    </h1>
    <div>
        <span class="badge rounded-pill {% if stream.is_online %}bg-success{% else %}bg-secondary{% endif %} me-2">
            {% if stream.is_online %}
                <i class="bi bi-check-circle-fill"></i> Online
            {% else %}
                <i class="bi bi-x-circle-fill"></i> Offline
            {% endif %}
        </span>
        <span class="badge rounded-pill bg-primary me-2">
            <i class="bi bi-people-fill"></i> {{ stream.current_viewers }} viewers
        </span>
        <button class="btn btn-sm btn-danger reset-stream-btn" data-stream-name="{{ original_name }}">
            <i class="bi bi-arrow-repeat"></i> Reset Stream
        </button>
    </div>
</div>
        <div class="row">
            <!-- Left Column -->
            <div class="col-md-8">
                <!-- Stats Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-graph-up"></i> Viewer Statistics (48 hours)
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Current Viewers</h5>
                                        <p class="card-text display-6">{{ stream.current_viewers }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Max Viewers</h5>
                                        <p class="card-text display-6">{{ stream.max_viewers }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <canvas id="viewerChart" height="150"></canvas>
                    </div>
                </div>

                  {% if current_user.role == "admin" %}
        <!-- Metadata Card (Admin Only) -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-code-slash"></i> Raw Metadata
            </div>
            <div class="card-body metadata-container">
                <pre>{{ metadata }}</pre>
            </div>
        </div>
        {% endif %}
            </div>
            

            <!-- Right Column -->
            <div class="col-md-4">
                                <!-- Input Statistics Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-input-cursor"></i> Input Statistics
                    </div>
                    <div class="card-body">
                        <div id="inputStatsContainer">
                            <!-- Stats will be loaded here dynamically -->
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Push Configurations Card -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-send"></i> Push Configurations</span>
                        <span class="badge bg-primary">{{ push_configs|length }}</span>
                    </div>
                    <div class="card-body">
                        {% if push_configs %}
                            <div class="push-status-section">
                                <div class="push-status-container">
                                    {% for push in push_configs %}
                                    <div class="push-config {% if not push.deactivated %}push-active{% else %}push-inactive{% endif %}">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <strong>Status:</strong>
                                                <span class="badge bg-{% if not push.deactivated %}success{% else %}danger{% endif %}">
                                                    {% if not push.deactivated %}ACTIVE{% else %}INACTIVE{% endif %}
                                                </span>
                                            </div>
                                            <div class="text-end">
                                                <div><strong>Target:</strong></div>
                                                <div class="push-target">
                                                    {{ push.target|truncate(20, True, '...') }}
                                                </div>
                                            </div>
                                        </div>
                                        {% if push.notes %}
                                        {% if current_user.role == "admin" %}
                                        <div class="push-notes mt-1">
                                            
                                            <strong>Notes:</strong> 
                                                {{ push.notes }}
                                        </div>
                                          {% endif %}
                                        {% endif %}
                                        <div class="push-controls mt-2">
                                            <div class="input-group input-group-sm mb-2">
                                                <input
                                                    type="text"
                                                    class="form-control push-url-input"
                                                    value="{{ push.target }}"
                                                />
                                                <button
                                                    class="btn btn-outline-primary update-url-btn"
                                                    data-push-id="{{ push.push_id }}"
                                                >
                                                    Update
                                                </button>
                                            </div>
                                            <div class="text-end">
                                                <button
                                                    class="btn btn-sm btn-{% if not push.deactivated %}warning{% else %}success{% endif %} toggle-push"
                                                    data-push-id="{{ push.push_id }}"
                                                    data-current-state="{% if not push.deactivated %}active{% else %}inactive{% endif %}"
                                                >
                                                    {% if not push.deactivated %}Deactivate{% else %}Activate{% endif %}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% else %}
                            <p class="text-muted">No push configurations for this stream.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Automatic Push Configuration Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-gear"></i> Automatic Push Configuration
                    </div>
                    <div class="card-body">
                        {% if push_configs %}
                            <div class="alert alert-info">
                                This stream has {{ push_configs|length }} automatic push configuration(s)
                            </div>
                            <button id="removeAutoPushBtn" class="btn btn-danger">
                                <i class="bi bi-trash"></i> Remove Automatic Push
                            </button>
                            
                            {% if push_configs|length > 1 %}
                                <div class="mt-3">
                                    <label class="form-label">Select Push to Remove:</label>
                                    <select class="form-select" id="pushToRemoveSelect">
                                        {% for push in push_configs %}
                                            <option value="{{ push.push_id }}">{{ push.target|truncate(30, True, '...') }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="mb-3">
                                <label for="pushTarget" class="form-label">Push Target URL</label>
                                <input type="text" class="form-control" id="pushTarget" placeholder="rtmp://example.com/app/streamkey">
                                <div class="form-text">Must start with rtmp://, rtmps://, or srt://</div>
                            </div>
                            <button id="addAutoPushBtn" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> Add Automatic Push
                            </button>
                        {% endif %}
                    </div>
                </div>

                <!-- Active Pushes Card -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-send-arrow-up"></i> Active Pushes</span>
                        <span class="badge bg-primary" id="activePushesCount">0</span>
                    </div>
                    <div class="card-body">
                        <div id="activePushesContainer">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Stream URLs Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-link-45deg"></i> Stream URLs
                    </div>
                    <div class="card-body">
                        <h5 class="card-title mb-3">Access this stream directly:</h5>
                        
                        <div class="mb-3">
                            <h6>RTMP URL:</h6>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control stream-url" value="rtmp://tir3.com/live/{{ original_name }}" readonly>
                                <button class="btn btn-outline-secondary copy-btn" type="button">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6>SRT URL:</h6>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control stream-url" value="srt://tir3.com:8889?streamid={{ original_name }}" readonly>
                                <button class="btn btn-outline-secondary copy-btn" type="button">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                        
                        {% if current_user.role == "admin" %}
                        <div class="mb-3">
                            <h6>HLS URL:</h6>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control stream-url" value="http://tir3.com/hls/{{ original_name }}/index.m3u8" readonly>
                                <button class="btn btn-outline-secondary copy-btn" type="button">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6>WebRTC URL:</h6>
                            <div class="input-group">
                                <input type="text" class="form-control stream-url" value="http://tir3.com/webrtc/{{ original_name }}" readonly>
                                <button class="btn btn-outline-secondary copy-btn" type="button">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                
                <!-- Embed Code Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-code"></i> Embed Code
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">Embed this stream</h5>
                        <div class="mb-3">
                            <label class="form-label">HTML Embed Code</label>
                            <textarea class="form-control" rows="5" readonly>{{ embed_code }}</textarea>
                        </div>
                        <button class="btn btn-primary copy-btn" data-target="textarea.form-control">
                            <i class="bi bi-clipboard"></i> Copy Embed Code
                        </button>
                    </div>
                </div>

            </div>
        </div>

                      {% if current_user.role == "admin" %}
                <!-- Processes Card (Admin Only) -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-gear"></i> Processes ({{ stream.processes|length }})
                    </div>
                    <div class="card-body">
                        {% for process in stream.processes %}
                        <div class="card process-card mb-3">
                            <div class="card-header">
                                Process #{{ loop.index }} - {{ process.process }}
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item">
                                                <strong>Type:</strong> {{ process.process }}
                                            </li>
                                            <li class="list-group-item">
                                                <strong>Sink:</strong> {{ process.sink }}
                                            </li>
                                            <li class="list-group-item">
                                                <strong>Restart Type:</strong> {{ process.restart_type }}
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item">
                                                <strong>Debug Level:</strong> {{ process.debug }}
                                            </li>
                                            <li class="list-group-item">
                                                <strong>Track Select:</strong> {{ process.track_select }}
                                            </li>
                                            <li class="list-group-item">
                                                <strong>Inconsequential:</strong> {{ process.inconsequential }}
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
    </div>

    <!-- Edit URL Modal -->
    <div class="modal fade" id="editPushModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Push URL</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="pushUrlInput" class="form-label">New Push URL</label>
                        <input type="text" class="form-control" id="pushUrlInput" placeholder="rtmp://example.com/app/streamkey">
                        <div class="form-text">Must start with rtmp://, rtmps://, or srt://</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="savePushUrlBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Optimize initial page load and connection handling
document.addEventListener('DOMContentLoaded', function() {
    // Initialize viewer chart with minimal data
const ctx = document.getElementById('viewerChart').getContext('2d');
const historyData = JSON.parse('{{ history_data|safe }}');

    // Only keep last 5 points for initial load
    const recentData = historyData.slice(-5);
    const timestamps = recentData.map(point => new Date(point.timestamp).toLocaleTimeString());
    const viewers = recentData.map(point => point.viewers);

viewerChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: timestamps,
        datasets: [{
            label: 'Viewers',
            data: viewers,
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1,
            fill: true
        }]
    },
    options: {
        responsive: true,
            animation: false,
            plugins: { legend: { display: false } },
        scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Viewers' } },
                x: { title: { display: true, text: 'Time' } }
        }
    }
});

    // Initialize WebSocket connections with retry mechanism
    initializeWebSockets();
});

// WebSocket connection management
let wsReconnectAttempts = 0;
const MAX_RECONNECT_ATTEMPTS = 3;
const RECONNECT_DELAY = 500;
let wsConnections = {
    input_stats: null,
    active_pushes: null,
    stream_data: null
};

function initializeWebSockets() {
    // Close any existing connections
    Object.values(wsConnections).forEach(ws => {
        if (ws && ws.readyState !== WebSocket.CLOSED) {
            ws.close();
        }
    });

    // Reset connection attempts
    wsReconnectAttempts = 0;

    // Connect to all WebSockets
    connectWebSocket('input_stats');
    connectWebSocket('active_pushes');
    connectWebSocket('stream_data');
}

function connectWebSocket(type) {
    // Don't create new connection if one exists and is connecting/connected
    if (wsConnections[type] && 
        (wsConnections[type].readyState === WebSocket.CONNECTING || 
         wsConnections[type].readyState === WebSocket.OPEN)) {
            return;
        }
        
    // Determine WebSocket protocol based on page protocol
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/ws/${type}/{{ original_name }}`;
    
    const ws = new WebSocket(wsUrl);
    wsConnections[type] = ws;

    ws.onopen = () => {
        console.log(`${type} WebSocket connected`);
        wsReconnectAttempts = 0; // Reset attempts on successful connection
    };

    ws.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            requestAnimationFrame(() => {
                switch(type) {
                    case 'input_stats':
                        updateInputStatsDisplay(data.input_stats);
                        break;
                    case 'active_pushes':
                        updateActivePushesDisplay(data.pushes);
                        break;
                    case 'stream_data':
                        updateStreamDataDisplay(data);
                        break;
                }
            });
        } catch (error) {
            console.error(`Error processing ${type} message:`, error);
        }
    };

    ws.onclose = (event) => {
        console.log(`${type} WebSocket closed:`, event.code, event.reason);
        
        // Only attempt reconnect if not closed cleanly
        if (event.code !== 1000) {
            if (wsReconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                wsReconnectAttempts++;
                setTimeout(() => connectWebSocket(type), RECONNECT_DELAY * wsReconnectAttempts);
        } else {
                showConnectionError(type);
            }
        }
    };

    ws.onerror = (error) => {
        console.error(`${type} WebSocket error:`, error);
        showConnectionError(type);
    };
}

function showConnectionError(type) {
    const container = document.getElementById(`${type}Container`);
    if (container) {
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> Connection lost. 
                <button class="btn btn-sm btn-outline-warning ms-2" onclick="reconnectWebSocket('${type}')">
                    Retry
                </button>
            </div>
        `;
    }
}

function reconnectWebSocket(type) {
    wsReconnectAttempts = 0;
    connectWebSocket(type);
}

// Optimize page visibility handling
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        // Don't close connections, just pause updates
        Object.values(wsConnections).forEach(ws => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'pause' }));
            }
        });
    } else {
        // Resume updates
        Object.values(wsConnections).forEach(ws => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'resume' }));
            }
        });
    }
});

// Network status handlers
window.addEventListener('online', function() {
    wsReconnectAttempts = 0;
    initializeWebSockets();
});

window.addEventListener('offline', function() {
    Object.values(wsConnections).forEach(ws => {
        if (ws) {
            ws.close(1000, 'Network offline');
        }
    });
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    Object.values(wsConnections).forEach(ws => {
        if (ws) {
            ws.close(1000, 'Page unload');
        }
    });
});

// Start WebSocket connections
initializeWebSockets();

// Copy buttons functionality
document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        let targetElement;
        
        if (this.dataset.target) {
            targetElement = document.querySelector(this.dataset.target);
        } else {
            targetElement = this.parentElement.querySelector('.stream-url') || 
                          this.parentElement.querySelector('textarea');
        }
        
        if (targetElement) {
            targetElement.select();
            document.execCommand('copy');
            
            // Show feedback
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="bi bi-check"></i> Copied!';
            setTimeout(() => {
                this.innerHTML = originalText;
            }, 2000);
        }
    });
});

// Reset Stream Functionality
document.querySelector('.reset-stream-btn').addEventListener('click', async function() {
    const button = this;
    const streamName = button.dataset.streamName;
    
    if (!confirm(`Are you sure you want to reset the stream "${streamName}"? This will temporarily interrupt the stream.`)) {
        return;
    }
    
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Resetting...';
    
    try {
        const response = await fetch('/api/reset_stream', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ stream_name: streamName })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update UI elements
            const statusBadge = document.querySelector('.stream-status-badge');
            if (statusBadge) {
                statusBadge.className = 'badge rounded-pill stream-status-badge me-2 bg-secondary';
                statusBadge.innerHTML = '<i class="bi bi-x-circle-fill"></i> Offline';
            }
            
            // Update viewer counts
            const viewerElements = [
                document.querySelector('.viewer-count'),
                document.querySelector('.current-viewers-display'),
                document.querySelector('.max-viewers-display')
            ];
            
            viewerElements.forEach(element => {
                if (element) {
                    element.textContent = '0';
                    element.style.transform = 'scale(1.1)';
                    element.style.color = '#dc3545';
                    setTimeout(() => {
                        element.style.transform = 'scale(1)';
                        element.style.color = '';
                    }, 300);
                }
            });
            
            // Update chart
            if (viewerChart) {
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                
                viewerChart.data.labels.push(timeString);
                viewerChart.data.datasets[0].data.push(0);
                
                if (viewerChart.data.labels.length > 20) {
                    viewerChart.data.labels.shift();
                    viewerChart.data.datasets[0].data.shift();
                }
                viewerChart.update('none');
            }
            
            // Show success message
        button.innerHTML = '<i class="bi bi-check-circle"></i> Done';
        setTimeout(() => {
                button.innerHTML = '<i class="bi bi-arrow-repeat"></i> Reset Stream';
                button.disabled = false;
            }, 2000);
            
            // Reconnect WebSockets after a short delay
            setTimeout(() => {
                if (inputStatsWs) inputStatsWs.close();
                if (activePushesWs) activePushesWs.close();
                if (streamDataWs) streamDataWs.close();
                connectWebSockets();
            }, 3000);
            
        } else {
            throw new Error(data.error || 'Reset failed');
        }
    } catch (error) {
        console.error('Reset error:', error);
        button.innerHTML = '<i class="bi bi-exclamation-circle"></i> Failed';
        setTimeout(() => {
            button.innerHTML = '<i class="bi bi-arrow-repeat"></i> Reset Stream';
            button.disabled = false;
        }, 2000);
    }
});

// Manual refresh button
document.getElementById('manual-refresh-btn')?.addEventListener('click', function() {
    const btn = this;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    btn.disabled = true;
    
    consecutiveErrors = 0;
    interval = 3000;
    
    updateStreamData().finally(() => {
        btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
        btn.disabled = false;
    });
});

// Push configuration toggle buttons
document.querySelectorAll('.toggle-push').forEach(btn => {
    btn.addEventListener('click', function() {
        const pushId = this.dataset.pushId;
        const currentState = this.dataset.currentState;
        const newState = currentState === 'active' ? 'inactive' : 'active';
        
        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        
        fetch('/api/toggle_push', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
                push_id: pushId,
                new_state: newState
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updatePushConfigsUI(); // Refresh the UI
            } else {
                throw new Error(data.error || 'Operation failed');
            }
        })
        .catch(error => {
            console.error('Error toggling push:', error);
            alert('Error: ' + error.message);
        });
    });
});

// Update push URL
document.querySelectorAll('.update-url-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const button = this;
        const input = button.closest('.input-group').querySelector('.push-url-input');
        const pushId = button.dataset.pushId;
        const newUrl = input.value.trim();

        if (!newUrl) {
            alert('Please enter a valid URL');
            return;
        }

        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        fetch('/api/update_push_url', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ 
                push_id: pushId, 
                new_url: newUrl 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updatePushConfigsUI(); // Refresh the UI
            } else {
                throw new Error(data.error || 'Update failed');
            }
        })
        .catch(error => {
            console.error('Error updating URL:', error);
            alert('Error: ' + error.message);
            button.innerHTML = 'Update';
        });
    });
});

// Real-time update function
async function updateStreamData() {
    if (isUpdating) return;
    isUpdating = true;
    
    try {
        const response = await fetch(`/api/stream/{{ original_name }}/details`, {
            headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' }
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        
    consecutiveErrors = 0;
    interval = 3000;
        
        // Update status badge
        const statusBadge = document.querySelector('.stream-status-badge');
        if (statusBadge) {
            const isOnline = data.is_online;
            statusBadge.className = `badge rounded-pill stream-status-badge me-2 ${isOnline ? 'bg-success' : 'bg-secondary'}`;
            statusBadge.innerHTML = isOnline ? 
                '<i class="bi bi-check-circle-fill"></i> Online' : 
                '<i class="bi bi-x-circle-fill"></i> Offline';
        }
        
        // Update viewer count in header
        const viewerCount = document.querySelector('.viewer-count');
        if (viewerCount && viewerCount.textContent !== String(data.current_viewers)) {
            viewerCount.textContent = data.current_viewers;
            viewerCount.style.transform = 'scale(1.2)';
            viewerCount.style.color = '#fff';
            setTimeout(() => {
                viewerCount.style.transform = 'scale(1)';
                viewerCount.style.color = '';
            }, 300);
        }
        
        // Update current viewers card
        const currentViewersDisplay = document.querySelector('.current-viewers-display');
        if (currentViewersDisplay && currentViewersDisplay.textContent !== String(data.current_viewers)) {
            currentViewersDisplay.style.transform = 'scale(1.1)';
            currentViewersDisplay.style.color = '#0d6efd';
            currentViewersDisplay.textContent = data.current_viewers;
            setTimeout(() => {
                currentViewersDisplay.style.transform = 'scale(1)';
                currentViewersDisplay.style.color = '';
            }, 300);
        }
        
        // Update max viewers card
        const maxViewersDisplay = document.querySelector('.max-viewers-display');
        if (maxViewersDisplay && data.max_viewers && maxViewersDisplay.textContent !== String(data.max_viewers)) {
            maxViewersDisplay.style.transform = 'scale(1.1)';
            maxViewersDisplay.style.color = '#198754';
            maxViewersDisplay.textContent = data.max_viewers;
            setTimeout(() => {
                maxViewersDisplay.style.transform = 'scale(1)';
                maxViewersDisplay.style.color = '';
            }, 300);
        }
        
        // Update chart
        if (viewerChart && data.current_viewers !== undefined) {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            
            viewerChart.data.labels.push(timeString);
            viewerChart.data.datasets[0].data.push(data.current_viewers);
            
            // Keep only last 20 points
            if (viewerChart.data.labels.length > 20) {
                viewerChart.data.labels.shift();
                viewerChart.data.datasets[0].data.shift();
            }
            viewerChart.update('none');
        }
        
        // Update last update time
        const lastUpdateTime = document.getElementById('last-update-time');
        if (lastUpdateTime) {
            lastUpdateTime.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
        }
        
    } catch (error) {
        consecutiveErrors++;
        interval = Math.min(3000 * consecutiveErrors, 15000);
        console.warn('Stream data update failed:', error.message);
        
        // Show error state
        const lastUpdateTime = document.getElementById('last-update-time');
        if (lastUpdateTime && consecutiveErrors > 2) {
            lastUpdateTime.innerHTML = `<span class="text-warning">Connection issues - retrying...</span>`;
        }
        
    } finally {
        isUpdating = false;
    clearTimeout(updateTimer);
        updateTimer = setTimeout(updateStreamData, interval);
    }
}

// Add skeleton loading styles
const skeletonStyles = document.createElement('style');
skeletonStyles.textContent = `
    @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
    }
    
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 1000px 100%;
        animation: shimmer 2s infinite linear;
        border-radius: 4px;
    }
    
    .skeleton-text {
        height: 1em;
        margin-bottom: 0.5em;
    }
    
    .skeleton-circle {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }
    
    .skeleton-badge {
        width: 80px;
        height: 24px;
        border-radius: 12px;
    }
`;

document.head.appendChild(skeletonStyles);

// Skeleton loading templates
const skeletonTemplates = {
    inputStats: `
        <div class="card mb-3 border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <div class="skeleton skeleton-circle"></div>
                        </div>
                        <div>
                            <div class="skeleton skeleton-text" style="width: 100px;"></div>
                            <div class="skeleton skeleton-text" style="width: 80px;"></div>
                        </div>
                    </div>
                    <div>
                        <div class="skeleton skeleton-badge"></div>
                    </div>
                </div>
            </div>
        </div>
    `,
    activePushes: `
        <div class="card mb-3 border-0 shadow-sm">
            <div class="card-body p-3">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <div class="skeleton skeleton-circle"></div>
                        </div>
                        <div>
                            <div class="skeleton skeleton-text" style="width: 80px;"></div>
                            <div class="skeleton skeleton-text" style="width: 60px;"></div>
                        </div>
                    </div>
                    <div>
                        <div class="skeleton skeleton-badge"></div>
                    </div>
                </div>
            </div>
        </div>
    `
};

// Initialize containers with skeleton loading
document.addEventListener('DOMContentLoaded', function() {
    const inputStatsContainer = document.getElementById('inputStatsContainer');
    const activePushesContainer = document.getElementById('activePushesContainer');
    
    if (inputStatsContainer) {
        inputStatsContainer.innerHTML = skeletonTemplates.inputStats;
    }
    
    if (activePushesContainer) {
        activePushesContainer.innerHTML = skeletonTemplates.activePushes;
    }
});

function updateInputStatsDisplay(stats) {
    const container = document.getElementById('inputStatsContainer');
    if (!container) return;

    if (!stats || !Array.isArray(stats) || stats.length === 0) {
        container.innerHTML = `
            <div class="card mb-3 border-success">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h5 class="mb-1">No Input Data</h5>
                            <p class="mb-0 text-muted">Waiting for stream input...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        return;
    }

    const isAdmin = {{ 'true' if current_user.role == "admin" else 'false' }};
    let html = '';
    
    if (isAdmin) {
        stats.forEach((inputStat, index) => {
            const hours = Math.floor(inputStat.connected_time / 3600);
            const minutes = Math.floor((inputStat.connected_time % 3600) / 60);
            const seconds = inputStat.connected_time % 60;
            const connTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            html += `
                <div class="card mb-3 border-success">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-broadcast"></i> Input #${index + 1}</span>
                        <span class="badge bg-success">‚óè LIVE</span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Host:</strong> ${inputStat.host || 'N/A'}</p>
                                <p><strong>Protocol:</strong> ${inputStat.protocol || 'N/A'}</p>
                                <p><strong>Connected:</strong> ${connTime}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Data:</strong> ${(inputStat.data_downloaded_gb || 0).toFixed(2)} GB, ${(inputStat.data_downloaded_mb || 0).toFixed(2)} MB</p>
                                <p><strong>Bitrate:</strong> ${(inputStat.current_bitrate_mbps || 0).toFixed(2)} Mbps</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
    } else {
        const inputStat = stats[0];
        const hours = Math.floor(inputStat.connected_time / 3600);
        const minutes = Math.floor((inputStat.connected_time % 3600) / 60);
        const seconds = inputStat.connected_time % 60;
        const connTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        html = `
            <div class="card mb-3 border-0 shadow-sm active-input">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <span class="badge bg-success rounded-pill live-pulse"></span>
                            </div>
                            <div>
                                <h5 class="mb-1 fw-bold text-dark">Uptime</h5>
                                <p class="mb-0 text-muted fs-6">Input Stream</p>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="badge bg-primary px-4 py-3" style="font-family: monospace; font-size: 1.1rem;">
                                <i class="bi bi-stopwatch me-2"></i>${connTime}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

function updateActivePushesDisplay(pushes) {
    const container = document.getElementById('activePushesContainer');
    const countBadge = document.getElementById('activePushesCount');
    if (!container || !countBadge) return;

    if (!pushes || pushes.length === 0) {
        container.innerHTML = `
            <div class="text-center py-3 text-muted">
                <i class="bi bi-send-slash"></i> No active pushes
            </div>
        `;
        countBadge.textContent = '0';
        return;
    }

    countBadge.textContent = pushes.length;
    let html = '';
    
    pushes.forEach((push, index) => {
        html += `
            <div class="card mb-3 border-primary active-push-card">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <span class="badge bg-primary rounded-pill push-pulse"></span>
                            </div>
                            <div>
                                <h5 class="mb-1 fw-bold text-dark">Push #${index + 1}</h5>
                                <p class="mb-0 text-muted fs-6">PID: ${push.pid}</p>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="badge bg-info px-4 py-3" style="font-family: monospace; font-size: 1.1rem;">
                                <i class="bi bi-stopwatch me-2"></i>${push.formatted_time}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function updateStreamDataDisplay(data) {
    // Update status badge
    const statusBadge = document.querySelector('.stream-status-badge');
    if (statusBadge) {
        const isOnline = data.is_online;
        statusBadge.className = `badge rounded-pill stream-status-badge me-2 ${isOnline ? 'bg-success' : 'bg-secondary'}`;
        statusBadge.innerHTML = isOnline ? 
            '<i class="bi bi-check-circle-fill"></i> Online' : 
            '<i class="bi bi-x-circle-fill"></i> Offline';
    }
    
    // Update viewer counts
    const viewerElements = {
        header: document.querySelector('.viewer-count'),
        current: document.querySelector('.current-viewers-display'),
        max: document.querySelector('.max-viewers-display')
    };

    Object.entries(viewerElements).forEach(([key, element]) => {
        if (element) {
            const value = key === 'max' ? data.max_viewers : data.current_viewers;
            if (element.textContent !== String(value)) {
                element.textContent = value;
                element.style.transform = 'scale(1.1)';
                element.style.color = key === 'max' ? '#198754' : '#0d6efd';
setTimeout(() => {
                    element.style.transform = 'scale(1)';
                    element.style.color = '';
                }, 300);
            }
        }
    });
    
    // Update chart
    if (viewerChart && data.current_viewers !== undefined) {
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        
        viewerChart.data.labels.push(timeString);
        viewerChart.data.datasets[0].data.push(data.current_viewers);
        
        if (viewerChart.data.labels.length > 20) {
            viewerChart.data.labels.shift();
            viewerChart.data.datasets[0].data.shift();
        }
        viewerChart.update('none');
    }
}

// Add styles for animations
const style = document.createElement('style');
style.textContent = `
    .live-pulse, .push-pulse {
        width: 12px;
        height: 12px;
        padding: 0;
        animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.4); }
        50% { opacity: 0.8; transform: scale(1.1); box-shadow: 0 0 0 8px rgba(25, 135, 84, 0); }
    }
    .active-input:hover, .active-push-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
        transition: all 0.3s ease;
    }
`;
document.head.appendChild(style);

// Modified updatePushConfigsUI function
async function updatePushConfigsUI() {
    try {
        const response = await fetch(`/api/streams`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (!response.ok) {
            if (response.status === 401) {
                localStorage.removeItem('token');
                window.location.href = '/login';
                return;
            }
            throw new Error('Failed to fetch stream data');
        }

        const data = await response.json();
        const stream = data.streams['{{ original_name }}'];
        if (!stream) return;

        // Update the Push Configurations card
        const pushConfigs = stream.push_configs || [];
        const pushConfigsCard = document.querySelector('.card .card-header:has(i.bi-send)')?.parentElement;
        if (pushConfigsCard) {
            let html = '';
            if (pushConfigs.length > 0) {
                html += `<div class="push-status-section"><div class="push-status-container">`;
                pushConfigs.forEach(push => {
                    const isAdmin = {{ 'true' if current_user.role == "admin" else 'false' }};
                    html += `
                        <div class="push-config ${!push.deactivated ? 'push-active' : 'push-inactive'}">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>Status:</strong> 
                                    <span class="badge bg-${!push.deactivated ? 'success' : 'danger'}">
                                        ${!push.deactivated ? 'ACTIVE' : 'INACTIVE'}
                                    </span>
                                </div>
                                <div class="text-end">
                                    <div><strong>Target:</strong></div>
                                    <div class="push-target">
                                        ${push.target.length > 20 ? push.target.substring(0, 20) + '...' : push.target}
                                    </div>
                                </div>
                            </div>
                            ${push.notes && isAdmin ? `<div class="push-notes mt-1"><strong>Notes:</strong> ${push.notes}</div>` : ''}
                            <div class="push-controls mt-2">
                                <div class="input-group input-group-sm mb-2">
                                    <input type="text" class="form-control push-url-input" value="${push.target}" />
                                    <button class="btn btn-outline-primary update-url-btn" data-push-id="${push.push_id}">
                                        Update
                                    </button>
                                </div>
                                <div class="text-end">
                                    <button class="btn btn-sm btn-${!push.deactivated ? 'warning' : 'success'} toggle-push" 
                                            data-push-id="${push.push_id}" 
                                            data-current-state="${!push.deactivated ? 'active' : 'inactive'}">
                                        ${!push.deactivated ? 'Deactivate' : 'Activate'}
                                    </button>
                                </div>
                            </div>
                        </div>`;
                });
                html += `</div></div>`;
            } else {
                html = '<p class="text-muted">No push configurations for this stream.</p>';
            }
            pushConfigsCard.querySelector('.card-body').innerHTML = html;
            
            // Update badge count
            const badge = pushConfigsCard.querySelector('.badge.bg-primary');
            if (badge) badge.textContent = pushConfigs.length;
        }

        // Update the Automatic Push Configuration card
        const autoPushCard = document.querySelector('.card .card-header:has(i.bi-gear)')?.parentElement;
        if (autoPushCard) {
            let html = '';
            if (pushConfigs.length > 0) {
                html += `
                    <div class="alert alert-info">
                        This stream has ${pushConfigs.length} automatic push configuration(s)
                    </div>
                    <button id="removeAutoPushBtn" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Remove Automatic Push
                    </button>`;
                
                if (pushConfigs.length > 1) {
                    html += `
                        <div class="mt-3">
                            <label class="form-label">Select Push to Remove:</label>
                            <select class="form-select" id="pushToRemoveSelect">
                                ${pushConfigs.map(push => 
                                    `<option value="${push.push_id}">${push.target.substring(0, 30)}${push.target.length > 30 ? '...' : ''}</option>`
                                ).join('')}
                            </select>
                        </div>`;
                }
            } else {
                html += `
                    <div class="mb-3">
                        <label for="pushTarget" class="form-label">Push Target URL</label>
                        <input type="text" class="form-control" id="pushTarget" placeholder="rtmp://example.com/app/streamkey">
                        <div class="form-text">Must start with rtmp://, rtmps://, or srt://</div>
                    </div>
                    <button id="addAutoPushBtn" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Add Automatic Push
                    </button>`;
            }
            autoPushCard.querySelector('.card-body').innerHTML = html;
        }

        // Rebind all event listeners after UI update
        bindPushConfigEventListeners();

    } catch (error) {
        console.error('Failed to update push configs UI:', error);
        alert('Error updating UI: ' + error.message);
    }
}

// New function to bind all push config event listeners
function bindPushConfigEventListeners() {
    // Bind toggle push buttons
    document.querySelectorAll('.toggle-push').forEach(btn => {
        btn.addEventListener('click', function() {
            const pushId = this.dataset.pushId;
            const currentState = this.dataset.currentState;
            const newState = currentState === 'active' ? 'inactive' : 'active';
            
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            
            fetch('/api/toggle_push', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({
                    push_id: pushId,
                    new_state: newState
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updatePushConfigsUI();
                } else {
                    throw new Error(data.error || 'Operation failed');
                }
            })
            .catch(error => {
                console.error('Error toggling push:', error);
                alert('Error: ' + error.message);
            });
        });
    });
    
    // Bind update URL buttons
    document.querySelectorAll('.update-url-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const button = this;
            const input = button.closest('.input-group').querySelector('.push-url-input');
            const pushId = button.dataset.pushId;
            const newUrl = input.value.trim();

            if (!newUrl) {
                alert('Please enter a valid URL');
                return;
            }

            button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            fetch('/api/update_push_url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({ 
                    push_id: pushId, 
                    new_url: newUrl 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updatePushConfigsUI();
                } else {
                    throw new Error(data.error || 'Update failed');
                }
            })
            .catch(error => {
                console.error('Error updating URL:', error);
                alert('Error: ' + error.message);
                button.innerHTML = 'Update';
            });
        });
    });
    
    // Bind add auto push button
    const addAutoPushBtn = document.getElementById('addAutoPushBtn');
    if (addAutoPushBtn) {
        addAutoPushBtn.addEventListener('click', async function() {
            const target = document.getElementById('pushTarget').value.trim();
            if (!target) {
                showDynamicToast('Please enter a target URL');
                return;
            }
            if (!target.startsWith('rtmp://') && !target.startsWith('rtmps://') && !target.startsWith('srt://')) {
                showDynamicToast('URL must start with rtmp://, rtmps://, or srt://');
                return;
            }

            const button = this;
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Adding...';
            button.disabled = true;

            try {
                const response = await fetch('/api/push_auto_add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        push_auto_add: {
                            stream: '{{ original_name }}',
                            target: target,
                            "x-LSP-notes": "Push from Live Fusion Dashboard"
                        }
                    })
                });

                const data = await response.json();
                
                if (response.status === 403 && data.error === "push_limit_reached") {
                    showDynamicToast(data.message);
                } 
                else if (!response.ok) {
                    throw new Error(data.error || 'Failed to add automatic push');
                }
                else {
                    showDynamicToast('Push added successfully!', 'success');
                    document.getElementById('pushTarget').value = '';
                    await updatePushConfigsUI();
                }
            } catch (error) {
                showDynamicToast(error.message);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });
    }
    
    // Bind remove auto push button
    const removeAutoPushBtn = document.getElementById('removeAutoPushBtn');
    if (removeAutoPushBtn) {
        removeAutoPushBtn.addEventListener('click', async function() {
            const button = this;
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Removing...';

            try {
                // Get the push ID from the select element or the first push config
                const pushToRemoveSelect = document.getElementById('pushToRemoveSelect');
                let pushId;
                
                if (pushToRemoveSelect) {
                    pushId = pushToRemoveSelect.value;
                } else {
                    // Get the first push config from the current stream data
                    const response = await fetch(`/api/streams`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to fetch stream data');
                    }
                    
                    const data = await response.json();
                    const stream = data.streams['{{ original_name }}'];
                    if (!stream || !stream.push_configs || stream.push_configs.length === 0) {
                        throw new Error('No push configuration to remove');
                    }
                    pushId = stream.push_configs[0].push_id;
                }

                if (!pushId) {
                    throw new Error('No push configuration to remove');
                }

                // Remove the push configuration
                const response = await fetch('/api/push_auto_remove', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ push_id: pushId })
                });

                if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = '/login';
                    return;
                }

                const data = await response.json();
                
                if (data.success) {
                    button.innerHTML = '<i class="bi bi-check"></i> Removed!';
                    await updatePushConfigsUI();
                    setTimeout(() => {
                        button.innerHTML = originalText;
                    }, 2000);
                } else {
                    throw new Error(data.error || 'Failed to remove automatic push');
                }
            } catch (error) {
                console.error('Error:', error);
                button.innerHTML = '<i class="bi bi-x"></i> Failed';
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
                alert('Error: ' + error.message);
            }
        });
    }
}

// Initialize the push config UI and event listeners when the page loads
document.addEventListener('DOMContentLoaded', function() {
    updatePushConfigsUI();
});

// Add toast and push management functions
function showDynamicToast(message, type = 'error') {
    const toastContainer = document.getElementById('toastContainer');
    
    // Create toast element
    const toastEl = document.createElement('div');
    toastEl.className = `toast show align-items-center text-white bg-${type === 'error' ? 'danger' : 'success'} border-0`;
    toastEl.setAttribute('role', 'alert');
    toastEl.setAttribute('aria-live', 'assertive');
    toastEl.setAttribute('aria-atomic', 'true');
    
    // Toast content
    toastEl.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    // Add to container
    toastContainer.appendChild(toastEl);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        toastEl.classList.remove('show');
        setTimeout(() => toastEl.remove(), 150);
    }, 5000);
}

</script>
</body>
</html>